<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Data Siswa - Chronos Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
    <style>
        /* Form / modal spacing improvements */
        .modal-content {
            padding: 28px 32px;
            box-sizing: border-box;
        }

        .modal-content form { 
            max-width: 720px; 
            margin: 0 auto; 
        }

        .form-group { 
            margin-bottom: 14px; 
        }

        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #222;
            font-size: 0.95rem;
            letter-spacing: 0.2px;
        }

        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;         /* horizontal padding fixed */
            border-radius: 6px;
            border: 1px solid #cdbfae;
            background: #f7efe7;
            box-sizing: border-box;
            font-size: 0.95rem;
            color: #222;
        }

        /* keep readonly styling but align padding */
        .form-group input[readonly] {
            background: rgba(0,0,0,0.05);
            color: #666;
            padding: 12px 14px;
        }

        small.helper-text {
            display: block;
            margin-top: 6px;
            color: #666;
            font-size: 0.85rem;
        }

        .btn-submit {
            width: 100%;
            padding: 12px 16px;
            border-radius: 6px;
            font-weight: 700;
        }

        @media (max-width: 640px) {
            .modal-content { padding: 18px; }
        }
    </style>
</head>
<body class="admin-page">

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chronos<br>Control</h2>
        </div>
        <ul class="nav-links">
            <li><a href="dashboard.html">üè† Dashboard</a></li>
            <li><a href="manage_materi.html">üìö Kelola Materi</a></li>
            <li><a href="manage_quest.html">‚öîÔ∏è Kelola Quest</a></li>
            <li><a href="manage_users.html">üë• Data Siswa</a></li>
            <li><a href="manage_schedule.html">üìÖ Kelola Jadwal</a></li>
            <li><a href="manage_calendar.html">üìÜ Kelola Event</a></li>
            <li><a href="#" onclick="sessionStorage.clear(); window.location.href='../login.html'">üö™ Logout</a></li>
        </ul>
        <div class="gear-decoration"><img src="../assets/gear_1.png" class="spin"></div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1>Data Siswa</h1>
            <div class="admin-info">Admin Mode</div>
        </div>

        <div class="panel-table">
            <table class="steampunk-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nama Lengkap</th>
                        <th>Username</th>
                        <th>Kelas</th>
                        <th>Level / Poin</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="6" align="center">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="font-family:'Cinzel',serif; text-align:center; margin-bottom:20px;">Edit Siswa</h2>
            
            <form id="userForm" onsubmit="submitUser(event)">
                <input type="hidden" id="userId">

                <div class="form-group">
                    <label>Nama Lengkap (Read Only)</label>
                    <input type="text" id="fullname" readonly style="background: rgba(0,0,0,0.2); color:#888;">
                </div>

                <div class="form-group">
                    <label>Ubah Kelas</label>
                    <select id="class_type">
                        <option value="None">Belum Pilih (None)</option>
                        <option value="ACT">A.C.T</option>
                        <option value="BCF">B.C.F</option>
                        <option value="CMS">C.M.S</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Reset Password (Opsional)</label>
                    <input type="text" id="new_password" placeholder="Isi jika ingin mengganti password user">
                    <small style="color: #666;">Biarkan kosong jika tidak ingin mengubah password.</small>
                </div>

                <button type="submit" class="btn-submit">SIMPAN PERUBAHAN</button>
            </form>
        </div>
    </div>

    <script>
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', loadUsers);

        // 1. Load Data
        async function loadUsers() {
            const tbody = document.getElementById('userTableBody');
            try {
                const res = await fetch('../php/admin_users.php');
                const result = await res.json();
                
                if(result.success) {
                    allUsers = result.data;
                    if(result.data.length > 0) {
                        tbody.innerHTML = result.data.map((u, index) => `
                            <tr>
                                <td>#${u.id}</td>
                                <td style="font-weight:bold; color:#ffcc00;">${u.fullname}</td>
                                <td>${u.username}</td>
                                <td><span class="badge-class">${u.class_type || 'None'}</span></td>
                                <td>Lvl ${u.level} <span style="color:#aaa">|</span> ${u.points} pts</td>
                                <td>
                                    <button class="btn-small" style="background:#2e8b57; color:white;" onclick="openEditModal(${index})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteUser(${u.id})">Hapus</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" align="center">Belum ada siswa yang mendaftar.</td></tr>';
                    }
                }
            } catch(e) {
                console.error(e);
            }
        }

        // 2. Submit Update
        async function submitUser(e) {
            e.preventDefault();
            
            const payload = {
                id: document.getElementById('userId').value,
                class_type: document.getElementById('class_type').value,
                new_password: document.getElementById('new_password').value
            };

            try {
                const res = await fetch('../php/admin_users.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if(result.success) {
                    alert(result.message);
                    closeModal();
                    loadUsers();
                } else {
                    alert("Gagal: " + result.message);
                }
            } catch(err) { console.error(err); }
        }

        // 3. Delete User
        async function deleteUser(id) {
            if(!confirm("Hapus siswa ini? Semua data progress quest & todo list user ini akan hilang permanen!")) return;
            
            try {
                const res = await fetch('../php/admin_users.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                const result = await res.json();
                if(result.success) loadUsers();
            } catch(err) { console.error(err); }
        }

        // --- Modal Control ---
        function openEditModal(index) {
            const u = allUsers[index];
            document.getElementById('userId').value = u.id;
            document.getElementById('fullname').value = u.fullname;
            document.getElementById('class_type').value = u.class_type;
            document.getElementById('new_password').value = ""; // Reset field password

            document.getElementById('userModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('userModal').style.display = 'none'; }
    </script>
</body>
</html>