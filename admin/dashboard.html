<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control - ChronosQuest</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cinzel+Decorative:wght@700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="admin-page">

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chronos<br>Control</h2>
        </div>
        <ul class="nav-links">
            <li class="active"><a href="dashboard.html">üè† Dashboard</a></li>
            <li><a href="manage_materi.html">üìö Kelola Materi</a></li>
            <li><a href="manage_quest.html">‚öîÔ∏è Kelola Quest</a></li>
            <li><a href="manage_users.html">üë• Data Siswa</a></li>
            <li><a href="manage_schedule.html">üìÖ Kelola Jadwal</a></li>
            <li><a href="manage_calendar.html">üìÜ Kelola Event</a></li>
            <li><a href="#" onclick="logoutAdmin()">üö™ Logout</a></li>
        </ul>
        <div class="gear-decoration">
            <img src="../assets/gear_1.png" class="spin">
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1>Engine Room</h1>
            <div class="admin-info">Admin: <span id="adminName">...</span></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Siswa</h3>
                <div class="number" id="countStudent">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Materi</h3>
                <div class="number" id="countMateri">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Quest</h3>
                <div class="number" id="countQuest">-</div>
            </div>
        </div>

        <div class="panel-table">
            <div class="panel-header">
                <h3>Siswa Terbaru Bergabung</h3>
            </div>
            <table class="steampunk-table">
                <thead>
                    <tr>
                        <th>Nama Lengkap</th>
                        <th>Kelas</th>
                        <th>Tanggal Join</th>
                    </tr>
                </thead>
                <tbody id="recentUserTable">
                    <tr><td colspan="3">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Cek Session Admin
        const userStr = sessionStorage.getItem('cq_current');
        if(!userStr) window.location.href = '../login.html';
        const user = JSON.parse(userStr);
        if(user.role !== 'admin') {
            alert("Akses Ditolak! Anda bukan Admin.");
            window.location.href = '../user/dashboard.html';
        }
        document.getElementById('adminName').textContent = user.fullname;

        function logoutAdmin() {
            sessionStorage.clear();
            window.location.href = '../login.html';
        }

        // Load Data Dashboard
        async function loadAdminData() {
            try {
                const response = await fetch('../php/admin_data.php');
                const result = await response.json();
                
                if(result.success) {
                    // Update Stats
                    document.getElementById('countStudent').innerText = result.data.counts.students;
                    document.getElementById('countMateri').innerText = result.data.counts.materials;
                    document.getElementById('countQuest').innerText = result.data.counts.quests;

                    // Update Table
                    const tableBody = document.getElementById('recentUserTable');
                    if(result.data.recent_users.length > 0) {
                        tableBody.innerHTML = result.data.recent_users.map(u => `
                            <tr>
                                <td>${u.fullname}</td>
                                <td><span class="badge-class">${u.class_type}</span></td>
                                <td>${u.created_at}</td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="3">Belum ada siswa.</td></tr>';
                    }
                }
            } catch(e) {
                console.error(e);
            }
        }

        document.addEventListener('DOMContentLoaded', loadAdminData);
    </script>
</body>
</html>