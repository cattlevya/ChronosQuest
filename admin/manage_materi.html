<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Kelola Materi - Chronos Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="admin-page">

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chronos<br>Control</h2>
        </div>
        <ul class="nav-links">
            <li><a href="dashboard.html">üè† Dashboard</a></li>
            <li class="active"><a href="manage_materi.html">üìö Kelola Materi</a></li>
            <li><a href="manage_quest.html">‚öîÔ∏è Kelola Quest</a></li>
            <li><a href="manage_users.html">üë• Data Siswa</a></li>
            <li><a href="manage_schedule.html">üìÖ Kelola Jadwal</a></li>
            <li><a href="manage_calendar.html">üìÜ Kelola Event</a></li>
            <li><a href="#" onclick="sessionStorage.clear(); window.location.href='../login.html'">üö™ Logout</a></li>
        </ul>
        <div class="gear-decoration"><img src="../assets/gear_1.png" class="spin"></div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1>Manajemen Materi</h1>
            <div class="admin-info">Admin Mode</div>
        </div>

        <div class="action-bar">
            <button class="btn-add" onclick="openModal()">+ Tambah Materi Baru</button>
        </div>

        <div class="panel-table">
            <table class="steampunk-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Judul Materi</th>
                        <th>Kategori</th>
                        <th>Deskripsi Singkat</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="materiTableBody">
                    <tr><td colspan="5" align="center">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="materiModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="font-family:'Cinzel',serif; text-align:center; margin-bottom:20px;">Input Materi</h2>
            
            <form id="materiForm" onsubmit="submitMateri(event)">
                <input type="hidden" id="materiId">

                <div class="form-group">
                    <label>Judul Materi</label>
                    <input type="text" id="title" required placeholder="Contoh: Belajar CSS Grid">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="category">
                        <option value="HTML">HTML</option>
                        <option value="CSS">CSS</option>
                        <option value="Javascript">Javascript</option>
                        <option value="Database">Database</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Link Konten (URL)</label>
                    <input type="text" id="url" placeholder="Link PDF atau Video">
                </div>
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="desc" rows="3" placeholder="Penjelasan singkat..."></textarea>
                </div>
                <button type="submit" class="btn-submit">SIMPAN DATA</button>
            </form>
        </div>
    </div>

    <script>
        // Variabel global untuk menyimpan data materi agar mudah diambil saat edit
        let allMaterials = [];

        // 1. Load Data Saat Halaman Dibuka
        document.addEventListener('DOMContentLoaded', loadMateri);

        async function loadMateri() {
            const tbody = document.getElementById('materiTableBody');
            try {
                const res = await fetch('../php/admin_materi.php');
                const result = await res.json();
                
                if(result.success) {
                    allMaterials = result.data; // Simpan ke variabel global
                    if(result.data.length > 0) {
                        tbody.innerHTML = result.data.map((item, index) => `
                            <tr>
                                <td>#${item.id}</td>
                                <td style="font-weight:bold; color:#ffcc00;">${item.title}</td>
                                <td><span class="badge-class">${item.category}</span></td>
                                <td>${item.description ? item.description.substring(0, 50) + '...' : '-'}</td>
                                <td>
                                    <button class="btn-small" style="background:#2e8b57; color:white;" onclick="openEditModal(${index})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteMateri(${item.id})">Hapus</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" align="center">Belum ada materi.</td></tr>';
                    }
                }
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" align="center" style="color:red">Gagal memuat data.</td></tr>';
            }
        }

        // 2. Fungsi Submit (Bisa Tambah Baru atau Update)
        async function submitMateri(e) {
            e.preventDefault();
            
            // Ambil data dari form
            const id = document.getElementById('materiId').value; // Cek ada ID atau tidak
            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const url = document.getElementById('url').value;
            const desc = document.getElementById('desc').value;

            const payload = {
                title: title, 
                category: category, 
                content_url: url, 
                description: desc
            };

            // Jika ID terisi, masukkan ke payload (untuk trigger Update di PHP)
            if(id) {
                payload.id = id;
            }

            try {
                const res = await fetch('../php/admin_materi.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if(result.success) {
                    alert(result.message);
                    closeModal();
                    loadMateri(); // Refresh tabel
                } else {
                    alert("Gagal: " + result.message);
                }
            } catch(err) { console.error(err); }
        }

        // 3. Fungsi Hapus Materi
        async function deleteMateri(id) {
            if(!confirm("Yakin ingin menghapus materi ini?")) return;
            
            try {
                const res = await fetch('../php/admin_materi.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                const result = await res.json();
                if(result.success) loadMateri();
            } catch(err) { console.error(err); }
        }

        // --- MODAL CONTROLS ---

        // Mode Tambah Baru (Reset Form)
        function openModal() { 
            document.getElementById('materiForm').reset(); // Kosongkan form
            document.getElementById('materiId').value = ""; // Kosongkan ID
            document.getElementById('modalTitle').innerText = "Tambah Materi Baru"; // Ganti Judul
            document.getElementById('materiModal').style.display = 'flex'; 
        }

        // Mode Edit (Isi Form dengan Data Lama)
        function openEditModal(index) {
            const item = allMaterials[index]; // Ambil data dari variabel global
            
            document.getElementById('materiId').value = item.id; // Isi ID (Hidden)
            document.getElementById('title').value = item.title;
            document.getElementById('category').value = item.category;
            document.getElementById('url').value = item.content_url;
            document.getElementById('desc').value = item.description;

            document.getElementById('modalTitle').innerText = "Edit Materi"; // Ganti Judul
            document.getElementById('materiModal').style.display = 'flex';
        }

        function closeModal() { 
            document.getElementById('materiModal').style.display = 'none'; 
        }
    </script>
</body>
</html>