<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Kelola Jadwal - Chronos Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="admin-page">

    <div class="sidebar">
        <div class="sidebar-header"><h2>Chronos<br>Control</h2></div>
        <ul class="nav-links">
            <li><a href="dashboard.html">üè† Dashboard</a></li>
            <li><a href="manage_materi.html">üìö Kelola Materi</a></li>
            <li><a href="manage_quest.html">‚öîÔ∏è Kelola Quest</a></li>
            <li><a href="manage_users.html">üë• Data Siswa</a></li>
            <li class="active"><a href="manage_schedule.html">üìÖ Kelola Jadwal</a></li>
            <li><a href="manage_calendar.html">üìÜ Kelola Event</a></li>
            <li><a href="#" onclick="sessionStorage.clear(); window.location.href='../login.html'">üö™ Logout</a></li>
        </ul>
        <div class="gear-decoration"><img src="../assets/gear_1.png" class="spin"></div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1>Manajemen Jadwal</h1>
            <div class="admin-info">Admin Mode</div>
        </div>

        <div class="action-bar">
            <button class="btn-add" onclick="openModal()">+ Tambah Jadwal</button>
        </div>

        <div class="panel-table">
            <table class="steampunk-table">
                <thead>
                    <tr>
                        <th>Hari</th>
                        <th>Jam</th>
                        <th>Mata Kuliah</th>
                        <th>Ruangan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                    <tr><td colspan="5" align="center">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="schedModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="font-family:'Cinzel',serif; text-align:center; margin-bottom:20px;">Input Jadwal</h2>
            
            <form id="schedForm" onsubmit="submitSched(event)">
                <input type="hidden" id="schedId">

                <div class="form-group">
                    <label>Hari</label>
                    <select id="day">
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                        <option value="Minggu">Minggu</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mata Kuliah</label>
                    <input type="text" id="subject" required placeholder="Contoh: Algoritma">
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1">
                        <label>Jam Mulai</label>
                        <input type="time" id="start" required>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Jam Selesai</label>
                        <input type="time" id="end" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ruangan</label>
                    <input type="text" id="room" required placeholder="Contoh: Lab 1 / Online">
                </div>
                <button type="submit" class="btn-submit">SIMPAN JADWAL</button>
            </form>
        </div>
    </div>

    <script>
        let allSched = []; // Simpan data global

        document.addEventListener('DOMContentLoaded', loadSchedule);

        async function loadSchedule() {
            const tbody = document.getElementById('scheduleTableBody');
            try {
                const res = await fetch('../php/admin_schedule.php');
                const result = await res.json();
                
                if(result.success) {
                    allSched = result.data; // Simpan ke variable global
                    if (result.data.length > 0) {
                        tbody.innerHTML = result.data.map((item, index) => `
                            <tr>
                                <td><span class="badge-class" style="background:#1a4f5a; color:#fff;">${item.day_name}</span></td>
                                <td style="color:#ffcc00;">${item.time_start} - ${item.time_end}</td>
                                <td style="font-weight:bold;">${item.subject_name}</td>
                                <td>${item.room}</td>
                                <td>
                                    <button class="btn-small" style="background:#2e8b57; color:white;" onclick="openEditModal(${index})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteSched(${item.id})">Hapus</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" align="center">Belum ada jadwal.</td></tr>';
                    }
                }
            } catch(e) { console.error(e); }
        }

        async function submitSched(e) {
            e.preventDefault();
            
            const payload = {
                id: document.getElementById('schedId').value, // Kirim ID
                day: document.getElementById('day').value,
                subject: document.getElementById('subject').value,
                start: document.getElementById('start').value,
                end: document.getElementById('end').value,
                room: document.getElementById('room').value
            };

            try {
                const res = await fetch('../php/admin_schedule.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if(result.success) {
                    alert(result.message);
                    closeModal();
                    loadSchedule();
                } else { alert("Gagal: " + result.message); }
            } catch(err) { console.error(err); }
        }

        async function deleteSched(id) {
            if(!confirm("Hapus jadwal ini?")) return;
            try {
                const res = await fetch('../php/admin_schedule.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                const result = await res.json();
                if(result.success) loadSchedule();
            } catch(err) { console.error(err); }
        }

        // --- MODAL LOGIC ---
        function openModal() { 
            document.getElementById('schedForm').reset();
            document.getElementById('schedId').value = "";
            document.getElementById('modalTitle').innerText = "Tambah Jadwal";
            document.getElementById('schedModal').style.display = 'flex'; 
        }

        function openEditModal(index) {
            const item = allSched[index];
            document.getElementById('schedId').value = item.id;
            document.getElementById('day').value = item.day_name;
            document.getElementById('subject').value = item.subject_name;
            document.getElementById('start').value = item.time_start;
            document.getElementById('end').value = item.time_end;
            document.getElementById('room').value = item.room;

            document.getElementById('modalTitle').innerText = "Edit Jadwal";
            document.getElementById('schedModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('schedModal').style.display = 'none'; }
    </script>
</body>
</html>